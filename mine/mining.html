<!-- 1) Phaser CDN -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

<!-- 2) Canvas 컨테이너 -->
<div id="mine-canvas" style="width:100%;max-width:860px;margin:16px auto;border-radius:16px;overflow:hidden"></div>

<script>
/** === CONFIG === */
const ASSETS = {
  miner:  'assets/miner_swing.png',  // 8프레임 스프라이트시트
  dust:   'assets/dust.png',
  shine:  'assets/shine.png',
  swingSfx: 'assets/swing.mp3',
  coinSfx:  'assets/coin.mp3'
};
const FRAME = { width: 256, height: 256, end: 7 }; // 0~7 총 8프레임

/** === PHASER GAME === */
let miningState = { running:false, crit:false };
let sceneRef = null;

const phaserConfig = {
  type: Phaser.AUTO,
  parent: 'mine-canvas',
  width: 860,
  height: 280,
  backgroundColor: '#3b0d0d',
  physics: { default: 'arcade' },
  audio: { disableWebAudio: false },
  scene: {
    preload, create, update
  }
};

const game = new Phaser.Game(phaserConfig);

function preload() {
  this.load.spritesheet('miner', ASSETS.miner, { frameWidth: FRAME.width, frameHeight: FRAME.height, endFrame: FRAME.end });
  this.load.image('dust', ASSETS.dust);
  this.load.image('shine', ASSETS.shine);
  this.load.audio('swingSfx', ASSETS.swingSfx);
  this.load.audio('coinSfx', ASSETS.coinSfx);

  // 로딩 바(간단)
  const w = this.cameras.main.width, h = this.cameras.main.height;
  const g = this.add.graphics();
  this.load.on('progress', v => {
    g.clear().fillStyle(0xffd166,1).fillRect(w*0.1, h*0.85, (w*0.8)*v, 6);
  });
}

function create() {
  sceneRef = this;

  // 배경 데코
  this.add.rectangle(0, 220, 2000, 8, 0x6f2f2f).setOrigin(0); // 지면

  // 캐릭터
  const miner = this.add.sprite(200, 190, 'miner', 0).setScale(0.9).setOrigin(0.5, 1.0);
  this.anims.create({
    key: 'mine',
    frames: this.anims.generateFrameNumbers('miner', { start: 0, end: FRAME.end }),
    frameRate: 12,
    repeat: -1
  });

  // 파편 그룹
  const dustGroup = this.add.group({ defaultKey: 'dust', maxSize: 40 });
  const shineGroup = this.add.group({ defaultKey: 'shine', maxSize: 12 });

  // 사운드
  const swingSfx = this.sound.add('swingSfx', { volume: 0.25 });
  const coinSfx  = this.sound.add('coinSfx',  { volume: 0.25 });

  // 상태 핸들러
  this.events.on('start-mining', () => {
    miner.play('mine');
    miningState.running = true;
    // 스윙 타이밍에 맞춰 파편/사운드
    this.time.addEvent({
      delay: 250, loop: true, callback: () => {
        if (!miningState.running) return;
        swingSfx.play();
        spawnDustBurst(this, dustGroup, 340, 190);
        if (Phaser.Math.Between(0, 7) === 0) { // 가끔 크리티컬 반짝
          spawnShine(this, shineGroup, 340, 150);
        }
      }
    });
  });

  this.events.on('stop-mining', () => {
    miningState.running = false;
    miner.stop().setFrame(0);
  });

  this.events.on('claim', () => {
    // 코인 반짝 연출
    for (let i=0;i<6;i++) this.time.delayedCall(i*80, () => spawnShine(this, shineGroup, 230+ i*18, 120));
    coinSfx.play();
  });

  // 초깃값(대기)
  this.events.emit('stop-mining');

  // 외부 버튼 바인딩 (기존 페이지 버튼 id 사용)
  bindUiButtons(this);
}

function update() { /* 필요 시 상태 기반 이펙트 확장 */ }

// 파편/반짝 유틸
function spawnDustBurst(scene, group, x, y) {
  for (let i=0;i<6;i++) {
    const p = group.get(x, y, 'dust');
    if (!p) continue;
    p.setActive(true).setVisible(true).setScale(Phaser.Math.FloatBetween(0.4,0.8)).setAlpha(0.9);
    scene.physics.world.enable(p);
    p.body.setVelocity(Phaser.Math.Between(60,160), Phaser.Math.Between(-220,-100));
    p.body.setGravityY(400);
    scene.tweens.add({ targets: p, alpha: 0, duration: 600, onComplete: () => { p.destroy(); }});
  }
}
function spawnShine(scene, group, x, y) {
  const s = group.get(x, y, 'shine');
  if (!s) return;
  s.setActive(true).setVisible(true).setScale(Phaser.Math.FloatBetween(0.5,0.9)).setAlpha(0);
  scene.tweens.add({ targets: s, y: y-30, alpha: 1, yoyo: true, duration: 420, onComplete: () => s.destroy() });
}

// 버튼 연결
function bindUiButtons(scene){
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const claimBtn = document.getElementById('claimBtn');

  if (startBtn) startBtn.addEventListener('click', () => scene.events.emit('start-mining'));
  if (stopBtn)  stopBtn.addEventListener('click',  () => scene.events.emit('stop-mining'));
  if (claimBtn) claimBtn.addEventListener('click', () => scene.events.emit('claim'));
}
</script>
