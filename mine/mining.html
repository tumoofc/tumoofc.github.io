<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TUMO – Claim</title>
<script src="https://unpkg.com/@solana/web3.js@1.91.6/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/bs58@5.0.0/dist/bs58.min.js"></script>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#fff;text-align:center;min-height:100dvh;padding:26px 12px;background:linear-gradient(160deg,#5a1010,#8c1414 45%,#b51616 85%);}
  .wrap{max-width:720px;margin:0 auto}
  h1{margin:12px 0 6px}
  .card{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:16px;margin-top:14px}
  .btn{display:inline-block;padding:12px 18px;border-radius:14px;text-decoration:none;cursor:pointer;font-weight:800;color:#111;background:linear-gradient(#ffd633,#f4b030);border:1px solid rgba(255,220,120,.8)}
  .muted{opacity:.85;margin-top:12px;font-size:13px}
  a{color:#ffd}
</style>
</head>
<body>
<div class="wrap">
  <h1>Claim Rewards</h1>
  <p class="muted">서버에 적립 확정(클레임) 요청을 보냅니다. 지갑 서명으로 검증됩니다.</p>

  <div class="card">
    <p>세션 포인트: <b id="points">0</b></p>
    <p>클레임 가능분: <b id="claimable">0</b></p>
    <button id="claimBtn" class="btn">✅ Claim Now</button>
    <p id="msg" class="muted"></p>
  </div>

  <p class="muted"><a href="/mine/mining.html">← Back to Mining</a></p>
</div>

<script>
const API_URL = "https://YOUR_API_DOMAIN.example.com/tumo/claim"; // TODO
let provider = null;

function getProvider(){
  if ("solana" in window && window.solana?.isPhantom) return window.solana;
  return null;
}

const points = Number(localStorage.getItem('tumo_points')||"0");
const lastClaimed = Number(localStorage.getItem('tumo_claimed')||"0");
const claimable = Math.max(0, points - lastClaimed);

document.getElementById('points').textContent = points.toFixed(3);
document.getElementById('claimable').textContent = claimable.toFixed(3);

async function claim(){
  const msgEl = document.getElementById('msg');
  if (claimable <= 0){ msgEl.textContent="클레임 할 포인트가 없습니다."; return; }

  provider = getProvider();
  if (!provider){ msgEl.textContent="Phantom 지갑이 필요합니다."; return; }

  try{
    const { publicKey } = await provider.connect({onlyIfTrusted:false});
    const signer = publicKey.toBase58();

    const ts = Date.now();
    const message = `TUMO-CLAIM|${ts}|${signer}|${claimable.toFixed(6)}`;
    const bytes = new TextEncoder().encode(message);
    const sig = await provider.signMessage(bytes, "utf8");
    const signature = bs58.default.encode(sig.signature);

    const payload = {
      chain:"solana",
      ts, signer, message, signature,
      claimPoints: claimable
    };

    if (!API_URL.startsWith("http")){
      msgEl.textContent = "[DRY RUN] API_URL 설정 필요";
      return;
    }

    const r = await fetch(API_URL, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await r.json();

    if (j.ok){
      localStorage.setItem('tumo_claimed', String(points)); // 전부 확정
      msgEl.textContent = "✅ Claim 완료!";
      location.reload();
    }else{
      msgEl.textContent = "서버 오류: " + (j.error||"");
    }
  }catch(e){
    document.getElementById('msg').textContent = "서명/요청 실패: " + e.message;
  }
}

document.getElementById('claimBtn').addEventListener('click', claim);
</script>
</body>
</html>
