<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TUMO ‚Äì Mining</title>
<!-- Solana web3 + bs58 (ÏÑúÎ™Ö/Í≤ÄÏ¶ùÏö© Ïù∏ÏΩîÎî©) -->
<script src="https://unpkg.com/@solana/web3.js@1.91.6/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/bs58@5.0.0/dist/bs58.min.js"></script>
<style>
  :root{ --w:min(94vw,900px); --card:min(92vw,560px); }
  /* üî¥ Î†àÎìú Í∑∏ÎùºÎç∞Ïù¥ÏÖò Î∞∞Í≤Ω */
  body{
    margin:0; font-family:"Segoe UI",system-ui,-apple-system,Roboto,Helvetica,Arial,sans-serif;
    color:#fff; text-align:center; min-height:100dvh; padding:26px 12px 32px;
    background:
      radial-gradient(circle at 50% 20%, rgba(255,110,90,.20), rgba(0,0,0,0) 60%),
      radial-gradient(circle at 80% 80%, rgba(255,70,50,.18), rgba(0,0,0,0) 60%),
      linear-gradient(160deg, #5a1010, #8c1414 45%, #b51616 85%);
  }
  .wrap{width:var(--w); margin:0 auto;}
  .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:22px;}
  .brand{display:flex; align-items:center; gap:10px;}
  .brand img{width:36px;height:36px}
  .brand strong{font-size:clamp(18px,3.2vw,22px)}
  .back{color:#ffd; text-decoration:none; font-weight:700; opacity:.9; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);}
  h1{font-size:clamp(24px,5vw,42px); margin:12px 0 6px}
  .lead{opacity:.92; margin-bottom:20px}

  .wallet{
    display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;
    margin: 10px auto 18px;
  }
  .chip{
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    padding: 8px 12px; border-radius:12px; font-weight:700;
  }
  .btn{
    display:inline-flex; align-items:center; gap:10px;
    padding:12px 18px; border-radius:14px; text-decoration:none; cursor:pointer;
    border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.12); color:#fff; font-weight:800;
    box-shadow:0 10px 22px rgba(0,0,0,.25);
    transition:transform .12s ease, filter .12s ease;
  }
  .btn:hover{ transform:translateY(-1px); filter:brightness(1.05); }
  .btn.primary{
    background:linear-gradient(#ffd633,#f4b030); border-color:rgba(255,220,120,.8); color:#1a1a1a;
  }
  .grid{display:grid; grid-template-columns:1fr; gap:12px; width:var(--card); margin:0 auto;}
  .card{
    text-align:left; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16);
    border-radius:18px; padding:18px; box-shadow:0 14px 36px rgba(0,0,0,.35);
  }
  .row{display:flex; justify-content:space-between; align-items:center; margin:8px 0}
  .label{opacity:.9}
  .value{font-weight:800}
  .meter{margin-top:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.15); overflow:hidden;}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,#ffd633,#ff8a4c); box-shadow:0 0 12px rgba(255,180,0,.55); transition:width .25s ease;}
  .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:16px;}
  .muted{opacity:.85; margin-top:14px; font-size:13px}

  .bot{width:clamp(120px,22vw,220px); display:block; margin:20px auto 8px; filter:drop-shadow(0 10px 26px rgba(0,0,0,.35));}
  footer{margin-top:24px; opacity:.8; font-size:12px}
  footer a{color:#fff;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <a href="/" class="back">‚Üê Back</a>
      <div class="brand">
        <img src="../assets/512TMC.png" alt="TUMO"><strong>TUMO Mining</strong>
      </div>
      <span style="width:64px"></span>
    </div>

    <img src="../assets/tutu.png" alt="Tumo Bot" class="bot" />
    <h1>Start Mining</h1>
    <p class="lead">Lightweight in-browser simulation. Signed updates can be verified by the server (no real crypto mining).</p>

    <!-- Wallet area -->
    <div class="wallet">
      <span id="walletStatus" class="chip">Wallet: <b>Disconnected</b></span>
      <button id="connectBtn"  class="btn primary">üîó Connect Phantom</button>
      <button id="disconnectBtn" class="btn">‚èè Disconnect</button>
    </div>

    <!-- Stat + Controls -->
    <div class="grid">
      <div class="card" role="region" aria-label="Mining panel">
        <div class="row"><span class="label">Status</span>      <span class="value" id="status">Idle</span></div>
        <div class="row"><span class="label">Points</span>      <span class="value" id="points">0.000</span></div>
        <div class="row"><span class="label">Hashrate (sim.)</span> <span class="value" id="hash">0 H/s</span></div>
        <div class="meter" aria-hidden="true"><div class="bar" id="bar"></div></div>

        <div class="actions">
          <button class="btn primary" id="startBtn">‚õè Start</button>
          <button class="btn" id="stopBtn">‚ñ† Stop</button>
          <button class="btn" id="resetBtn">‚Ü∫ Reset</button>
        </div>

        <p class="muted">
          This is a harmless demo that simulates progress using timers.
          It does not mine real cryptocurrencies or call remote RPCs.
        </p>
      </div>
    </div>

    <footer>
      Symbol & Logo ¬© TUMO Foundation ¬∑ ¬© 2025 TUMO Foundation. All rights reserved.
    </footer>
  </div>

<script>
(function(){
  // ====== CONFIG ======
  const API_URL = "https://YOUR_API_DOMAIN.example.com/tumo/mining"; // TODO: Ï£ºÏù∏Îãò ÏÑúÎ≤Ñ URLÎ°ú ÍµêÏ≤¥
  const SEND_INTERVAL_MS = 30_000;  // 30Ï¥àÎßàÎã§ ÏÑúÎ≤ÑÎ°ú Í∏∞Î°ù Ï†ÑÏÜ°

  // ====== UI Refs ======
  const statusEl = document.getElementById('status');
  const pointsEl = document.getElementById('points');
  const hashEl   = document.getElementById('hash');
  const barEl    = document.getElementById('bar');

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const resetBtn = document.getElementById('resetBtn');

  const walletStatusEl = document.getElementById('walletStatus');
  const connectBtn     = document.getElementById('connectBtn');
  const disconnectBtn  = document.getElementById('disconnectBtn');

  // ====== State ======
  let running   = false;
  let points    = parseFloat(localStorage.getItem('tumo_points') || "0");
  let tick      = 0;
  let timer     = null;

  let sessionId = localStorage.getItem('tumo_session') || crypto.randomUUID();
  localStorage.setItem('tumo_session', sessionId);

  let lastSentPoints = parseFloat(localStorage.getItem('tumo_last_sent') || "0");

  // Wallet
  let provider = null;  // Phantom provider
  let pubkeyBase58 = null;

  // ====== Helpers ======
  function fmt(n){ return n.toFixed(3); }
  function short(addr){ return addr ? (addr.slice(0,4) + "‚Ä¶" + addr.slice(-4)) : "-"; }

  function setHashrate(){
    const base = 120 + Math.sin(tick/10)*20 + Math.random()*10; // ~120~150 H/s
    hashEl.textContent = base.toFixed(0) + ' H/s';
  }

  function savePoints(){
    localStorage.setItem('tumo_points', String(points));
  }
  function saveLastSent(){
    localStorage.setItem('tumo_last_sent', String(lastSentPoints));
  }

  function loop(){
    tick++;
    points += 0.005 + Math.random()*0.004;
    pointsEl.textContent = fmt(points);
    barEl.style.width = ((tick % 100)/100*100) + '%';
    setHashrate();
  }

  function start(){
    if (running) return;
    running = true;
    statusEl.textContent = 'Mining‚Ä¶';
    timer = setInterval(loop, 100); // 10x/sec
  }
  function stop(){
    if (!running) return;
    running = false;
    statusEl.textContent = 'Paused';
    clearInterval(timer);
    timer = null;
    savePoints();
    sendUpdate("stop");
  }
  function reset(){
    stop();
    points = 0; tick = 0;
    lastSentPoints = 0; saveLastSent();
    pointsEl.textContent = fmt(points);
    hashEl.textContent = '0 H/s';
    barEl.style.width = '0%';
    statusEl.textContent = 'Idle';
    savePoints();
    sendUpdate("reset");
  }

  // ====== Wallet(Phantom) ======
  function getProvider(){
    if ("solana" in window) {
      const p = window.solana;
      if (p?.isPhantom) return p;
    }
    return null;
  }

  async function connectWallet(){
    provider = getProvider();
    if (!provider){
      alert("Phantom wallet not found. Please install Phantom.");
      window.open("https://phantom.app/", "_blank");
      return;
    }
    try{
      const resp = await provider.connect({ onlyIfTrusted:false });
      pubkeyBase58 = resp.publicKey.toBase58();
      walletStatusEl.innerHTML = `Wallet: <b>${short(pubkeyBase58)}</b>`;
    }catch(e){
      console.warn("connect error", e);
      alert("Wallet connection rejected.");
    }
  }

  async function disconnectWallet(){
    try{
      if (provider?.isConnected) await provider.disconnect();
    }catch(e){ /* ignore */ }
    pubkeyBase58 = null;
    walletStatusEl.innerHTML = `Wallet: <b>Disconnected</b>`;
  }

  // ====== Signed update to Server ======
  async function signMessage(messageBytes){
    // Phantom: signMessage(feature) ÌïÑÏöî
    if (!provider?.signMessage) throw new Error("Wallet does not support signMessage API.");
    const signed = await provider.signMessage(messageBytes, "utf8");
    return signed.signature; // Uint8Array
  }

  async function sendUpdate(reason="auto"){
    try{
      // ÏïÑÎ¨¥ ÏßÄÍ∞ë ÏóÜÏù¥ÎèÑ Í∏∞Î°ùÏùÄ Î≥¥ÎÇº Ïàò ÏûàÍ≤å(ÏòµÏÖò). ÌïòÏßÄÎßå ÏßÄÍ∞ë ÏûàÏúºÎ©¥ ÏÑúÎ™Ö Ìè¨Ìï®.
      const ts = Date.now();
      const total = Number(points);
      const delta = Math.max(0, total - lastSentPoints);
      // deltaÍ∞Ä 0Ïù¥Î©¥ Ï†ÑÏÜ° ÏÉùÎûµ
      if (delta <= 0 && reason==="auto") return;

      const msgStr = `TUMO|${sessionId}|${ts}|${total.toFixed(6)}|${delta.toFixed(6)}`;
      const msgBytes = new TextEncoder().encode(msgStr);

      let signatureB58 = null;
      let signer = null;

      if (pubkeyBase58){
        try{
          const sig = await signMessage(msgBytes);
          signatureB58 = bs58.default.encode(sig);
          signer = pubkeyBase58;
        }catch(e){
          console.warn("signMessage failed:", e);
        }
      }

      const body = {
        chain: "solana",
        sessionId,
        ts,
        reason,
        totalPoints: total,
        deltaPoints: delta,
        signer,                        // ÏßÄÍ∞ë Ï£ºÏÜå (ÏûàÏúºÎ©¥)
        signature: signatureB58,       // ÏÑúÎ™Ö(base58, ÏûàÏúºÎ©¥)
        message: msgStr,               // ÏÑúÎ≤Ñ Í≤ÄÏ¶ùÏö© ÏõêÎ¨∏
        userAgent: navigator.userAgent
      };

      if (!API_URL.startsWith("http")) {
        console.log("[DRY-RUN] Replace API_URL to enable server logging:", body);
      } else {
        await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(body),
          keepalive: true
        });
      }

      // ÏÑ±Í≥µÏúºÎ°ú Í∞ÑÏ£ºÌïòÍ≥† lastSent Í∞±Ïã†
      lastSentPoints = total; saveLastSent();
    }catch(e){
      console.warn("sendUpdate error:", e);
    }
  }

  // ====== Event bindings ======
  startBtn.addEventListener('click', ()=>{ start(); savePoints(); });
  stopBtn .addEventListener('click', stop);
  resetBtn.addEventListener('click', reset);

  connectBtn.addEventListener('click', connectWallet);
  disconnectBtn.addEventListener('click', disconnectWallet);

  // ====== Init ======
  pointsEl.textContent = fmt(points);
  if (getProvider()?.isConnected){
    pubkeyBase58 = getProvider().publicKey?.toBase58() || null;
    walletStatusEl.innerHTML = `Wallet: <b>${short(pubkeyBase58)}</b>`;
  }

  // Ï£ºÍ∏∞Ï†Å Ï†ÄÏû•/Ï†ÑÏÜ°
  setInterval(()=>{ if (running) savePoints(); }, 5_000);
  setInterval(()=>{ sendUpdate("auto"); }, SEND_INTERVAL_MS);
})();
</script>
</body>
</html>
