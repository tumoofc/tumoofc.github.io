<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TUMO – Mining (Hand-held + Progress + Ads + Anti-AFK)</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

<!-- (선택) AdSense Auto Ads: 실제 client-id 넣고 주석 해제
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
-->

<style>
  :root{ --card-w:min(860px,92vw); --gold:#f4c063; --bg:#2c0606; --panel:#3b0d0d; }
  *{ box-sizing:border-box }
  body{ margin:0; background:#1a0000; color:#fff; font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Roboto,Arial }
  .wrap{ max-width:var(--card-w); margin:20px auto; padding:0 12px; }
  .title{ font-size:28px; font-weight:800; text-align:center; margin:6px 0 10px }
  .card{ background:var(--panel); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.4); padding:14px }
  .toolbar{ position:relative; z-index:10; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:8px 0 10px }
  .btn{ appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; pointer-events:auto }
  .btn.start{ background:#ffd166; color:#3b1f00 }
  .btn.stop{ background:#3a3a3a; color:#eaeaea }
  .btn.claim{ background:#87e8a8; color:#00331b }
  #mine-canvas{ position:relative; z-index:1; width:100%; height:auto; display:block; background:var(--bg); border-radius:14px; overflow:hidden; }

  /* 진행바 */
  .prog{ height:10px; background:#3d1b1b; border-radius:6px; overflow:hidden; margin:10px 2px 0 }
  .prog-fill{ height:100%; width:0%; background:linear-gradient(90deg,#ffcc66,#ff9b3d); transition:width .2s ease; }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:8px 2px }
  .kpi{ font-size:14px; opacity:.95 }
  .cap{ font-weight:800; color:#ffd166 }
  .status{ text-align:center; opacity:.9; margin:6px 0 2px; font-size:14px }

  /* 광고 슬롯(더미) */
  .ad-top, .ad-sticky{ display:flex; justify-content:center; }
  .ad-box{ width:728px; height:90px; max-width:100%; background:#2c2c2c; border:1px dashed #777; color:#bbb; display:flex; align-items:center; justify-content:center; border-radius:10px; font-size:13px; margin:8px auto 10px }
  .ad-sticky{ position:fixed; left:0; right:0; bottom:6px; z-index:999 }
  .ad-sticky .ad-box{ width:320px; height:50px; margin:0 auto }

  /* Anti-AFK 모달 */
  .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:1000 }
  .modal.show{ display:grid }
  .modal .box{ width:min(440px, 92vw); background:#1f0a0a; border:2px solid #ffb347; border-radius:16px; padding:18px }
  .modal .t{ font-weight:800; font-size:20px; margin-bottom:10px }
  .modal .c{ font-size:14px; opacity:.95; margin-bottom:14px }
  .modal .actions{ display:flex; gap:10px; justify-content:flex-end }
  .btn.primary{ background:#ffd166; color:#3b1f00; }
  .btn.ghost{ background:#3a3a3a; color:#eaeaea; }
</style>
</head>
<body>
  <!-- 상단 배너 광고 (더미 div → 실제 광고태그로 교체) -->
  <div class="ad-top"><div class="ad-box">Top Banner Ad (728×90 / 320×100)</div></div>

  <div class="wrap">
    <div class="title">Start Mining</div>
    <div class="card">
      <div class="toolbar">
        <button id="startBtn" class="btn start" onclick="startMiningBtn()">▶ Start</button>
        <button id="stopBtn"  class="btn stop"  onclick="stopMiningBtn()">Ⅱ Stop</button>
        <button id="claimBtn" class="btn claim" onclick="claimBtn()">✔ Claim</button>
      </div>

      <div id="mine-canvas"></div>

      <div class="prog"><div id="progFill" class="prog-fill"></div></div>

      <div class="row">
        <div class="kpi">Status: <span id="status">Ready.</span></div>
        <div class="kpi">Today: <span id="pNow" class="cap">0</span> / <span id="pCap" class="cap">60</span> P</div>
      </div>
    </div>
  </div>

  <!-- 하단 앵커 광고 (더미) -->
  <div class="ad-sticky"><div class="ad-box">Bottom Anchor Ad (320×50)</div></div>

  <!-- Anti-AFK 팝업 -->
  <div id="afkModal" class="modal" aria-hidden="true">
    <div class="box">
      <div class="t">Anti-AFK 확인</div>
      <div class="c">계속 채굴하려면 <b>10초 이내</b>에 확인 버튼을 눌러주세요.</div>
      <div class="actions">
        <button id="afkCancel" class="btn ghost">일시정지</button>
        <button id="afkOk" class="btn primary">계속</button>
      </div>
      <div class="c" id="afkCountdown" style="margin-top:8px; opacity:.8">남은 시간: 10초</div>
    </div>
  </div>

<script>
/* ===== 설정/상태 ===== */
const DAILY_CAP = 60;               // 일일 상한 (UI/데모)
const POINTS_PER_SEC = 0.6;         // 데모: 초당 포인트(실제 지급은 서버/E_day)
const ui = {
  status: document.getElementById('status'),
  pNow:   document.getElementById('pNow'),
  pCap:   document.getElementById('pCap'),
  start:  document.getElementById('startBtn'),
  stop:   document.getElementById('stopBtn'),
  claim:  document.getElementById('claimBtn'),
  bar:    document.getElementById('progFill')
}; ui.pCap.textContent = DAILY_CAP;
function setStatus(t){ ui.status.textContent = t; }
function setProgress(p){ ui.bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }

/* Anti-AFK 상태 */
const afk = {
  el: document.getElementById('afkModal'),
  ok: document.getElementById('afkOk'),
  cancel: document.getElementById('afkCancel'),
  countdown: document.getElementById('afkCountdown'),
  interval: null, sec: 10, timer: null
};
function openAntiAfk(){
  afk.el.classList.add('show'); afk.el.setAttribute('aria-hidden','false');
  afk.sec = 10; afk.countdown.textContent = `남은 시간: ${afk.sec}초`;
  clearInterval(afk.interval);
  afk.interval = setInterval(()=>{
    afk.sec--; afk.countdown.textContent = `남은 시간: ${afk.sec}초`;
    if(afk.sec<=0) closeAntiAfk(false);
  },1000);
  afk.ok.onclick    = ()=> closeAntiAfk(true);
  afk.cancel.onclick= ()=> closeAntiAfk(false);
}
function closeAntiAfk(continueMining){
  clearInterval(afk.interval);
  afk.el.classList.remove('show'); afk.el.setAttribute('aria-hidden','true');
  if(!continueMining){ mining=false; stopSwingLoop(); setStatus('Paused by Anti-AFK.'); }
}

/* ===== 에셋 경로 ===== */
const PAGE_DIR   = location.pathname.replace(/[^\/]+$/, ''); // '/mine/'
const ASSET_BASE = PAGE_DIR + 'assets/';
const ASSETS = {
  miner : ASSET_BASE + 'tutu_swing.png',  // 256x256 x 8
  dust  : ASSET_BASE + 'dust.png',
  shine : ASSET_BASE + 'shine.png',
  swing : ASSET_BASE + 'swing.mp3',
  coin  : ASSET_BASE + 'coin.mp3'
};

/* ===== Phaser ===== */
const W=860, H=280;
let sceneRef=null, mining=false, pToday=0, lastAntiAfk=0;
let minerCon=null, minerSprite=null, pickaxe=null, ore=null, swingLoop=null;
let dustGroup=null, shineGroup=null, swingSfx=null, coinSfx=null;

const game = new Phaser.Game({
  type:Phaser.AUTO, parent:'mine-canvas', width:W, height:H,
  backgroundColor:'#3b0d0d', physics:{ default:'arcade' }, audio:{ disableWebAudio:false },
  scene:{ preload, create, update }
});

function preload(){
  const g=this.add.graphics();
  this.load.on('progress', v=>{ g.clear().fillStyle(0xf4c063,1).fillRect(W*0.1,H*0.90,(W*0.8)*v,6); });
  this.load.on('complete', ()=>g.destroy());

  this.load.spritesheet('miner',ASSETS.miner,{frameWidth:256,frameHeight:256,endFrame:7});
  this.load.image('dust',ASSETS.dust);
  this.load.image('shine',ASSETS.shine);
  this.load.audio('swing',ASSETS.swing);
  this.load.audio('coin', ASSETS.coin);

  // dust/shine이 없어도 코드로 생성
  this.load.once('complete', ()=>{
    if(!this.textures.exists('dust'))  makeDustTex(this);
    if(!this.textures.exists('shine')) makeShineTex(this);
  });

  // 픽액스/광석은 코드로 생성
  makeOreTex(this);      // 'ore'
  makePickaxeTex(this);  // 'pickaxe'
}

function create(){
  sceneRef=this;
  setStatus('Ready.');
  this.add.rectangle(0,220,2000,8,0x4a1e1e,0.7).setOrigin(0);

  /* === 캐릭터 + 곡괭이: 컨테이너로 묶기 === */
  minerCon = this.add.container(250, 210);   // 캐릭터 발 위치(전체 이동은 여기서)
  minerSprite = this.add.sprite(0, 0, 'miner', 0).setOrigin(0.5, 1.0).setScale(0.9);
  this.anims.create({ key:'mine', frames:this.anims.generateFrameNumbers('miner',{start:0,end:7}), frameRate:12, repeat:-1 });

  // 손 위치에 곡괭이 고정(피벗=손잡이 하단)
  pickaxe = this.add.image(+18, -68, 'pickaxe').setOrigin(0.15,0.85).setScale(0.95).setAngle(-60);
  minerCon.add([minerSprite, pickaxe]);

  // 광석: 캐릭터 오른쪽
  ore = this.add.image(minerCon.x + 180, 210, 'ore').setOrigin(0.5,1).setScale(1.05);

  // 이펙트/사운드
  dustGroup  = this.add.group({ defaultKey:'dust',  maxSize:60 });
  shineGroup = this.add.group({ defaultKey:'shine', maxSize:20 });
  swingSfx   = this.sound.add('swing',{volume:0.22});
  coinSfx    = this.sound.add('coin',{volume:0.22});

  // 버튼
  ui.start.addEventListener('click', startMiningBtn);
  ui.stop .addEventListener('click', stopMiningBtn);
  ui.claim.addEventListener('click', claimBtn);

  // Anti-AFK: 5분마다 확인
  lastAntiAfk = this.time.now;
  setInterval(()=>{ if(mining) openAntiAfk(); }, 5*60*1000);
}

function update(time, delta){
  if(!mining) return;

  // 진행(초당 포인트)
  const dt = delta / 1000;
  if(pToday < DAILY_CAP){
    pToday = Math.min(DAILY_CAP, +(pToday + POINTS_PER_SEC * dt).toFixed(3));
    ui.pNow.textContent = pToday.toFixed(3).replace(/\.000$/,'');
    setProgress((pToday/DAILY_CAP)*100);
    if(pToday >= DAILY_CAP){ mining=false; stopSwingLoop(); setStatus('Daily cap reached.'); }
  }
}

/* ===== 버튼 폴백(전역) ===== */
function startMiningBtn(){
  if(!sceneRef){ setStatus('Loading…'); return; }
  if (pToday >= DAILY_CAP){ setStatus('Daily cap reached.'); return; }
  mining = true; minerSprite.play('mine'); startSwingLoop(); setStatus('Mining…');
}
function stopMiningBtn(){
  mining = false; stopSwingLoop(); minerSprite.stop().setFrame(0); setStatus('Paused.');
}
function claimBtn(){
  coinSfx?.play();
  for (let i=0;i<6;i++) sceneRef.time.delayedCall(i*80, ()=>spawnShine(sceneRef, shineGroup, minerCon.x-10+i*18, 120));
  setStatus('Claim event fired (서버 연동 지점).');
}

/* ===== 스윙 루프 & 이펙트 ===== */
function swingOnce(){
  if(!mining || !sceneRef) return;

  // 캐릭터 손에서 ore 방향으로 스윙
  pickaxe.setAngle(-60);
  sceneRef.tweens.add({
    targets: pickaxe,
    angle: 10,
    duration: 220,
    ease: 'Cubic.InOut',
    onComplete: ()=>{
      const hitX = ore.x - 14, hitY = ore.y - 22; // 히트 지점
      spawnDustBurst(sceneRef, dustGroup, hitX, hitY);
      if (Phaser.Math.Between(0,3)===0) spawnShine(sceneRef, shineGroup, hitX, hitY-28);
      sceneRef.tweens.add({ targets: pickaxe, angle: -60, duration: 180, ease:'Cubic.Out' });
    }
  });

  try{
    if (swingSfx?.context?.state==='suspended') swingSfx.context.resume();
    swingSfx?.play();
  }catch{}
}
function startSwingLoop(){ stopSwingLoop(); swingLoop = sceneRef.time.addEvent({ delay:320, loop:true, callback:swingOnce }); }
function stopSwingLoop(){ if(swingLoop){ swingLoop.remove(false); swingLoop=null; } }

/* ===== 프로시저럴 텍스처 & 이펙트 ===== */
function spawnDustBurst(scene, group, x, y){
  for(let i=0;i<7;i++){
    const p=group.get(x,y,'dust'); if(!p) continue;
    p.setActive(true).setVisible(true).setScale(Phaser.Math.FloatBetween(0.35,0.8)).setAlpha(0.95);
    scene.physics.world.enable(p);
    p.body.setVelocity(Phaser.Math.Between(80,160), Phaser.Math.Between(-240,-120));
    p.body.setGravityY(460);
    scene.tweens.add({ targets:p, alpha:0, duration:650, onComplete:()=>p.destroy() });
  }
}
function spawnShine(scene, group, x, y){
  const s=group.get(x,y,'shine'); if(!s) return;
  s.setActive(true).setVisible(true).setScale(Phaser.Math.FloatBetween(0.55,0.9)).setAlpha(0);
  scene.tweens.add({ targets:s, y:y-32, alpha:1, yoyo:true, duration:460, onComplete:()=>s.destroy() });
}
// dust 원형 파티클
function makeDustTex(scene){ const g=scene.add.graphics(); g.fillStyle(0x7a5b4b,1).fillCircle(8,8,8); g.generateTexture('dust',16,16); g.destroy(); }
// shine 별 파티클
function makeShineTex(scene){ const g=scene.add.graphics(); g.fillStyle(0xffe08a,1); g.fillTriangle(8,0,12,16,4,16); g.fillTriangle(0,8,16,12,16,4); g.generateTexture('shine',16,16); g.destroy(); }
// 광석
function makeOreTex(scene){ const g=scene.add.graphics(); g.fillStyle(0x6b4d3f,1).fillEllipse(60,60,118,56); g.fillStyle(0x7a5b4b,1).fillEllipse(42,62,52,28); g.fillEllipse(78,60,46,26); g.generateTexture('ore',120,80); g.destroy(); }
// 곡괭이(손잡이+머리)
function makePickaxeTex(scene){ const g=scene.add.graphics(); g.fillStyle(0x8b5a2b,1).fillRoundedRect(28,12,10,64,4); g.fillStyle(0xc8cbd1,1).fillRoundedRect(8,2,44,16,6); g.fillStyle(0x9aa0a6,1).fillTriangle(40,2,62,16,40,30); g.generateTexture('pickaxe',64,80); g.destroy(); }
</script>
</body>
</html>
