<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TUMO — Start Mining</title>
  <link rel="icon" href="../assets/favicon.png">
  <style>
    :root{
      --bg1:#6b0f11; --bg2:#380505;
      --card:#ffffff10; --muted:#ffffffb3; --text:#fff;
      --brand:#ffc93b; --accent:#ffe083; --ok:#19d27e; --warn:#ffb020;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 50% -10%, #8e1c1f 0%, var(--bg1) 40%, var(--bg2) 100%);
      display:flex; align-items:center; justify-content:center; padding:28px;
    }
    .wrap{ width:min(980px, 96vw); }
    h1{ font-size:clamp(28px, 4vw, 44px); margin:0 0 8px; font-weight:900 }
    p.lead{ color:var(--muted); margin:0 0 18px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; margin:14px 0 18px }
    .btn{
      background:#ffd54f; color:#1a1a1a; font-weight:800; border:none;
      padding:10px 16px; border-radius:12px; cursor:pointer;
      box-shadow:0 8px 20px #00000030;
    }
    .btn.warn{ background:#fff1c7 }
    .btn.outline{ background:transparent; border:1px solid #ffffff40; color:#fff }
    .btn:disabled{ opacity:.5; cursor:not-allowed }
    .badge{ padding:10px 14px; border-radius:12px; background:#ffffff0f; border:1px solid #ffffff24; }
    .card{
      background: #0000001f; border:1px solid #ffffff2a; border-radius:16px;
      backdrop-filter: blur(2px) saturate(120%);
      padding:18px; box-shadow:0 16px 40px #00000035;
    }
    .label{ opacity:.9; font-weight:700 }
    .value{ font-weight:900 }
    .kv{ display:grid; grid-template-columns:140px 1fr; gap:8px 14px; margin:10px 0 }
    .meter{ height:8px; border-radius:999px; background:#ffffff29; position:relative; overflow:hidden }
    .bar{ position:absolute; left:0; top:0; height:100%; width:35%; background:linear-gradient(90deg,#ffcf4f,#ffb54f); box-shadow:0 0 14px #ffcf4f }
    footer{ margin-top:18px; color:#ffffffa8; font-size:12px; text-align:center }
    a{ color:#ffe28a }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Start Mining</h1>
    <p class="lead">Lightweight in-browser simulation. Signed updates can be verified by the server (no real crypto mining).</p>

    <!-- 지갑 상태 / 연결 버튼 -->
    <div class="row">
      <div id="walletBadge" class="badge">Wallet: <b>Disconnected</b></div>
      <button id="connectBtn" class="btn">🔗 Connect Phantom</button>
      <button id="disconnectBtn" class="btn outline" disabled>⏏ Disconnect</button>
      <a href="../index.html" class="btn outline">← Back</a>
      <a href="../leaderboard.html" class="btn outline">🏆 Leaderboard</a>
    </div>

    <!-- 마이닝 카드 -->
    <div class="card">
      <div class="kv">
        <div class="label">Status</div>
        <div class="value" id="status">Paused</div>

        <div class="label">Points</div>
        <div class="value"><span id="points">0</span></div>

        <div class="label">Hashrate (sim.)</div>
        <div class="value"><span id="hash">135</span> H/s</div>
      </div>

      <div class="meter"><div class="bar" id="bar"></div></div>

      <div class="row">
        <button id="startBtn" class="btn">▶ Start</button>
        <button id="stopBtn"  class="btn warn" disabled>⏸ Stop</button>
        <button id="resetBtn" class="btn outline">↺ Reset</button>
        <button id="claimBtn" class="btn">💰 Claim Now</button>
      </div>

      <div id="msg" class="lead" style="min-height:24px;"></div>
    </div>

    <footer>Symbol &amp; Logo © TUMO Foundation · © 2025 TUMO Foundation. All rights reserved.</footer>
  </div>

<script>
/* =========================
   0) 전역/상수/저장키
========================= */
const API_URL   = "https://api.example.com";   // ← 서버 붙일 때 변경 (예: https://tumo-worker.example.workers.dev)
const TICK_SEC  = 30;                          // 30초마다 적립/기록
const PT_PER_TK = 1;                           // tick당 포인트
const LS_TOTAL  = "tumo_total_points";
const LS_LAST_CLAIM = "tumo_last_claim_points";

let wallet = { pubkey: null };
let mining = { timer: null, startedAt: 0 };
let points = Number(localStorage.getItem(LS_TOTAL) || 0);
let lastClaim = Number(localStorage.getItem(LS_LAST_CLAIM) || 0);

const ui = {
  badge: document.getElementById('walletBadge'),
  msg:   document.getElementById('msg'),
  status:document.getElementById('status'),
  bar:   document.getElementById('bar'),
  points:document.getElementById('points'),
  connect:document.getElementById('connectBtn'),
  disconnect:document.getElementById('disconnectBtn'),
  start: document.getElementById('startBtn'),
  stop:  document.getElementById('stopBtn'),
  reset: document.getElementById('resetBtn'),
  claim: document.getElementById('claimBtn'),
};

render();

/* =========================
   1) Phantom 지갑 연결/해제
========================= */
async function connectWallet(){
  try{
    if (!window.solana?.isPhantom){
      ui.msg.textContent = "Phantom wallet not found. Please install Phantom.";
      window.open('https://phantom.app/', '_blank');
      return;
    }
    const resp = await window.solana.connect();
    wallet.pubkey = resp.publicKey.toBase58();
    ui.badge.innerHTML = `Wallet: <b>${short(wallet.pubkey)}</b>`;
    ui.connect.disabled = true;
    ui.disconnect.disabled = false;
    ui.msg.textContent = "✅ Wallet connected.";
  }catch(e){
    ui.msg.textContent = "Wallet connection cancelled.";
  }
}
function disconnectWallet(){
  try{
    if (window.solana?.isConnected) window.solana.disconnect();
  }catch(_){}
  wallet.pubkey = null;
  ui.badge.innerHTML = `Wallet: <b>Disconnected</b>`;
  ui.connect.disabled = false;
  ui.disconnect.disabled = true;
  ui.msg.textContent = "Wallet disconnected.";
}

ui.connect.addEventListener('click', connectWallet);
ui.disconnect.addEventListener('click', disconnectWallet);

/* =========================
   2) 마이닝 Start/Stop/Reset
========================= */
function startMining(){
  if (mining.timer) return;
  ui.status.textContent = "Running";
  ui.start.disabled = true;
  ui.stop.disabled = false;
  ui.msg.textContent = "⛏ Mining started.";

  mining.startedAt = Date.now();
  tickLoop(); // 즉시 한 번
  mining.timer = setInterval(tickLoop, TICK_SEC * 1000);
}

function stopMining(){
  if (!mining.timer) return;
  clearInterval(mining.timer); mining.timer = null;
  ui.status.textContent = "Paused";
  ui.start.disabled = false;
  ui.stop.disabled = true;
  ui.msg.textContent = "⏸ Mining paused.";
  // 멈출 때도 서버에 flush
  flushUpdate("stop");
}

function resetMining(){
  stopMining();
  points = 0;
  localStorage.setItem(LS_TOTAL, String(points));
  ui.points.textContent = points;
  ui.msg.textContent = "↺ Reset complete.";
  flushUpdate("reset");
}

ui.start.addEventListener('click', startMining);
ui.stop.addEventListener('click', stopMining);
ui.reset.addEventListener('click', resetMining);

/* =========================
   3) 30초마다 tick 적립 + 서버 기록
========================= */
async function tickLoop(){
  // 포인트 적립
  points += PT_PER_TK;
  localStorage.setItem(LS_TOTAL, String(points));
  ui.points.textContent = points;

  // 진행바 애니메이션(장식)
  const w = (Date.now() / 200) % 100;
  ui.bar.style.width = (25 + (w/100)*60) + "%";

  // 서버로 서명 포함 기록(연결 X 이어도 로컬 적립은 계속)
  flushUpdate("tick").catch(()=>{ /* 네트워크 실패 시 조용히 무시 */ });
}

window.addEventListener('beforeunload', () => flushUpdate("unload"));
window.addEventListener('visibilitychange', () => {
  if (document.hidden) flushUpdate("hidden");
});

/* =========================
   4) Claim Now
   - 로컬 누적(points)에서 마지막 클레임(lastClaim) 차액만 서버 확정
========================= */
async function claimNow(){
  const delta = Math.max(0, points - lastClaim);
  if (delta <= 0){
    ui.msg.textContent = "No claimable points.";
    return;
  }
  try{
    const payload = {
      type: "claim",
      pubkey: wallet.pubkey || null,
      points: delta,
      totalPoints: points,
      ts: Date.now()
    };
    const signed = await maybeSign(payload);

    await postJSON(`${API_URL}/claim/submit`, signed);

    lastClaim = points;
    localStorage.setItem(LS_LAST_CLAIM, String(lastClaim));
    ui.msg.textContent = `💰 Claimed ${delta} pts.`;
  }catch(e){
    ui.msg.textContent = "Claim failed: " + (e.message || e);
  }
}
ui.claim.addEventListener('click', claimNow);

/* =========================
   5) 서버 전송 유틸
========================= */
async function flushUpdate(reason="tick"){
  // 서버 주소 미설정 시 건너뜀
  if (!API_URL || !/^https?:\/\//.test(API_URL)) return;

  const payload = {
    type: "update",
    reason,
    ts: Date.now(),
    pubkey: wallet.pubkey || null,
    points,
    lastClaim,
    tickSec: TICK_SEC,
  };
  const signed = await maybeSign(payload);
  try{
    await postJSON(`${API_URL}/mine/tick`, signed);
  }catch(_){}
}

async function postJSON(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json().catch(()=> ({}));
}

/* =========================
   6) 메시지 서명(있으면)
========================= */
async function maybeSign(obj){
  // 서버 검증을 위해 서명 포함(지갑 미연결이면 unsigned)
  const m = new TextEncoder().encode(
    "TUMO Mining @ " + new Date().toISOString() + "\n" + JSON.stringify(obj)
  );
  let sigBase58 = null, pubkey = wallet.pubkey || null;
  if (window.solana?.isPhantom && window.solana.publicKey){
    try{
      const { signature } = await window.solana.signMessage(m, "utf8");
      sigBase58 = bs58Encode(signature);
      pubkey = window.solana.publicKey.toBase58();
    }catch(_){}
  }
  return { ...obj, signer: pubkey, signature: sigBase58 };
}

/* =========================
   7) 기타 유틸
========================= */
function short(s, n=4){ return !s ? "" : s.slice(0,n) + "…" + s.slice(-n) }
function render(){
  ui.points.textContent = points;
  if (wallet.pubkey){
    ui.badge.innerHTML = `Wallet: <b>${short(wallet.pubkey)}</b>`;
    ui.connect.disabled = true; ui.disconnect.disabled = false;
  }else{
    ui.badge.innerHTML = `Wallet: <b>Disconnected</b>`;
    ui.connect.disabled = false; ui.disconnect.disabled = true;
  }
}

/* bs58 (경량 인코딩용) */
function bs58Encode(buf){
  const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  const BASE = ALPHABET.length;
  let x = [...buf];
  let digits = [0];
  for (let i=0; i<x.length; i++){
    for (let j=0, carry=x[i]; j<digits.length; j++){
      carry += digits[j] << 8;
      digits[j] = carry % BASE;
      carry = (carry / BASE) | 0;
    }
    while (carry) { digits.push(carry % BASE); carry = (carry / BASE) | 0; }
  }
  let zeros = 0; while (zeros < x.length && x[zeros] === 0) zeros++;
  return '1'.repeat(zeros) + digits.reverse().map(d => ALPHABET[d]).join('');
}
</script>
</body>
</html>
