<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TUMO – Mining (FINAL)</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
<style>
  :root{ --card-w:min(860px,92vw); --gold:#f4c063; --bg:#2c0606; --panel:#3b0d0d; }
  *{ box-sizing:border-box }
  body{ margin:0; background:#1a0000; color:#fff; font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Roboto,Arial }
  .wrap{ max-width:var(--card-w); margin:20px auto; padding:0 12px; }
  .title{ font-size:28px; font-weight:800; text-align:center; margin:6px 0 10px }
  .card{ background:var(--panel); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.4); padding:14px }
  .toolbar{ position:relative; z-index:10; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:8px 0 10px }
  .btn{ appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; pointer-events:auto }
  .btn.start{ background:#ffd166; color:#3b1f00 }
  .btn.stop{ background:#3a3a3a; color:#eaeaea }
  .btn.claim{ background:#87e8a8; color:#00331b }
  #mine-canvas{ position:relative; z-index:1; width:100%; height:auto; display:block; background:var(--bg); border-radius:14px; overflow:hidden; }
  .bar{ height:6px; background:#452020; border-radius:3px; margin:8px 0 0 }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:8px 2px }
  .kpi{ font-size:14px; opacity:.95 }
  .cap{ font-weight:800; color:#ffd166 }
  .status{ text-align:center; opacity:.9; margin:6px 0 2px; font-size:14px }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">Start Mining</div>
    <div class="card">
      <!-- 클릭 폴백: onclick 으로도 동작하도록 -->
      <div class="toolbar">
        <button id="startBtn" class="btn start" onclick="startMiningBtn()">▶ Start</button>
        <button id="stopBtn"  class="btn stop"  onclick="stopMiningBtn()">Ⅱ Stop</button>
        <button id="claimBtn" class="btn claim" onclick="claimBtn()">✔ Claim</button>
      </div>
      <div id="mine-canvas"></div>
      <div class="bar"></div>
      <div class="row">
        <div class="kpi">Status: <span id="status">Ready.</span></div>
        <div class="kpi">Today: <span id="pNow" class="cap">0</span> / <span id="pCap" class="cap">60</span> P</div>
      </div>
    </div>
  </div>

<script>
/* ===== UI / CONFIG ===== */
const DAILY_CAP = 60;
const POINTS_PER_SEC = 0.6; // 데모용
const ui = {
  status: document.getElementById('status'),
  pNow:   document.getElementById('pNow'),
  pCap:   document.getElementById('pCap'),
  start:  document.getElementById('startBtn'),
  stop:   document.getElementById('stopBtn'),
  claim:  document.getElementById('claimBtn')
}; ui.pCap.textContent = DAILY_CAP;
function setStatus(t){ ui.status.textContent = t; }

/* ===== Assets ===== */
const PAGE_DIR   = location.pathname.replace(/[^\/]+$/, ''); // '/mine/'
const ASSET_BASE = PAGE_DIR + 'assets/';
const ASSETS = {
  miner : ASSET_BASE + 'tutu_swing.png',  // 256x256 x 8프레임
  dust  : ASSET_BASE + 'dust.png',
  shine : ASSET_BASE + 'shine.png',
  swing : ASSET_BASE + 'swing.mp3',
  coin  : ASSET_BASE + 'coin.mp3'
};

/* ===== Phaser Game ===== */
const W=860, H=280;
let sceneRef=null, mining=false, pToday=0, lastTick=0;
let minerSprite=null, pickaxe=null, ore=null, swingLoop=null;
let dustGroup=null, shineGroup=null, swingSfx=null, coinSfx=null;

const game = new Phaser.Game({
  type:Phaser.AUTO, parent:'mine-canvas', width:W, height:H,
  backgroundColor:'#3b0d0d', physics:{ default:'arcade' }, audio:{ disableWebAudio:false },
  scene:{ preload, create, update }
});

function preload(){
  const g=this.add.graphics();
  const draw=(v)=>{ g.clear().fillStyle(0xf4c063,1).fillRect(W*0.1,H*0.90,(W*0.8)*v,6); };
  this.load.on('progress',draw); this.load.on('complete',()=>g.destroy());

  this.load.spritesheet('miner',ASSETS.miner,{frameWidth:256,frameHeight:256,endFrame:7});
  this.load.image('dust',ASSETS.dust);
  this.load.image('shine',ASSETS.shine);
  this.load.audio('swing',ASSETS.swing);
  this.load.audio('coin', ASSETS.coin);

  makeOreTex(this);      // 'ore'
  makePickaxeTex(this);  // 'pickaxe'
}

function create(){
  sceneRef=this;
  setStatus('Ready.');
  this.add.rectangle(0,220,2000,8,0x4a1e1e,0.7).setOrigin(0);

  minerSprite = this.add.sprite(200,190,'miner',0).setOrigin(0.5,1.0).setScale(0.9);
  this.anims.create({ key:'mine', frames:this.anims.generateFrameNumbers('miner',{start:0,end:7}), frameRate:12, repeat:-1 });

  ore     = this.add.image(360,210,'ore').setOrigin(0.5,1).setScale(1.0);
  pickaxe = this.add.image(248,138,'pickaxe').setOrigin(0.15,0.85).setScale(0.95).setAngle(-35);

  dustGroup  = this.add.group({ defaultKey:'dust',  maxSize:40 });
  shineGroup = this.add.group({ defaultKey:'shine', maxSize:12 });
  swingSfx   = this.sound.add('swing',{volume:0.22});
  coinSfx    = this.sound.add('coin',{volume:0.22});

  // 보조: addEventListener도 그대로 유지(이중 바인딩)
  ui.start.addEventListener('click', startMiningBtn);
  ui.stop .addEventListener('click', stopMiningBtn);
  ui.claim.addEventListener('click', claimBtn);
}

function update(time,delta){
  if(!mining){ lastTick=time; return; }
  const dt=(time-(lastTick||time))/1000; lastTick=time;
  if(pToday<DAILY_CAP){
    pToday=Math.min(DAILY_CAP, +(pToday + POINTS_PER_SEC*dt).toFixed(3));
    ui.pNow.textContent=pToday.toFixed(3).replace(/\.000$/,'');
    if(pToday>=DAILY_CAP){ mining=false; stopSwingLoop(); setStatus('Daily cap reached.'); }
  }
}

/* ===== 버튼 폴백 (전역) ===== */
function startMiningBtn(){
  if(!sceneRef){ setStatus('Loading…'); return; }
  if (pToday >= DAILY_CAP){ setStatus('Daily cap reached.'); return; }
  mining=true;
  try{ minerSprite.play('mine'); }catch{}
  startSwingLoop();
  setStatus('Mining…');
}
function stopMiningBtn(){
  mining=false; stopSwingLoop();
  try{ minerSprite.stop().setFrame(0); }catch{}
  setStatus('Paused.');
}
function claimBtn(){
  try{ coinSfx?.play(); }catch{}
  for (let i=0;i<6;i++) sceneRef.time.delayedCall(i*80, ()=>spawnShine(sceneRef, shineGroup, 230+i*18, 120));
  setStatus('Claim event fired (서버 연동 지점).');
}

/* ===== 스윙 루프 & 이펙트 ===== */
function swingOnce(){
  if(!mining || !sceneRef) return;
  pickaxe.setAngle(-50);
  sceneRef.tweens.add({
    targets: pickaxe, angle: 15, duration: 220, ease:'Cubic.InOut',
    onComplete: ()=>{
      spawnDustBurst(sceneRef, dustGroup, ore.x-10, ore.y-20);
      if (Phaser.Math.Between(0,3)===0) spawnShine(sceneRef, shineGroup, ore.x-6, ore.y-50);
    }
  });
  try{
    if (swingSfx?.context?.state==='suspended') swingSfx.context.resume();
    swingSfx?.play();
  }catch{}
}
function startSwingLoop(){ stopSwingLoop(); swingLoop = sceneRef.time.addEvent({ delay:300, loop:true, callback:swingOnce }); }
function stopSwingLoop(){ if(swingLoop){ swingLoop.remove(false); swingLoop=null; } }

/* ===== 도형 텍스처 ===== */
function spawnDustBurst(scene, group, x, y){
  for(let i=0;i<6;i++){
    const p=group.get(x,y,'dust'); if(!p) continue;
    p.setActive(true).setVisible(true).setScale(Phaser.Math.FloatBetween(0.4,0.8)).setAlpha(0.9);
    scene.physics.world.enable(p);
    p.body.setVelocity(Phaser.Math.Between(60,160), Phaser.Math.Between(-220,-100));
    p.body.setGravityY(420);
    scene.tweens.add({ targets:p, alpha:0, duration:600, onComplete:()=>p.destroy() });
  }
}
function spawnShine(scene, group, x, y){
  const s=group.get(x,y,'shine'); if(!s) return;
  s.setActive(true).setVisible(true).setScale(Phaser.Math.FloatBetween(0.5,0.9)).setAlpha(0);
  scene.tweens.add({ targets:s, y:y-30, alpha:1, yoyo:true, duration:420, onComplete:()=>s.destroy() });
}
function makeOreTex(scene){
  const g=scene.add.graphics();
  g.fillStyle(0x6b4d3f,1).fillEllipse(60,60,118,56);
  g.fillStyle(0x7a5b4b,1).fillEllipse(42,62,52,28); g.fillEllipse(78,60,46,26);
  g.generateTexture('ore',120,80); g.destroy();
}
function makePickaxeTex(scene){
  const g=scene.add.graphics();
  g.fillStyle(0x8b5a2b,1).fillRoundedRect(28,12,10,64,4);           // handle
  g.fillStyle(0xc8cbd1,1).fillRoundedRect(8,2,44,16,6);             // head
  g.fillStyle(0x9aa0a6,1).fillTriangle(40,2,62,16,40,30);           // tip
  g.generateTexture('pickaxe',64,80); g.destroy();
}
</script>
</body>
</html>
